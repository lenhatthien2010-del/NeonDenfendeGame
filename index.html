<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Defense - Extreme Glow v.1.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        
        :root { 
            --neon-blue: #00f2ff; 
            --neon-purple: #bc13fe; 
            --neon-red: #ff003c; 
            --neon-yellow: #fde047;
            --neon-green: #10b981;
            --neon-cyan: #22d3ee;
        }
        body { background-color: #020617; margin: 0; overflow: hidden; font-family: 'Orbitron', sans-serif; color: #fff; user-select: none; }
        
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        canvas { display: block; touch-action: none; background: #020617; }

        .glass-panel { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(20px); border: 1px solid rgba(0, 242, 255, 0.2); }
        
        .neon-btn {
            position: relative;
            transition: 0.3s;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 242, 255, 0.2);
        }
        .neon-btn:hover { box-shadow: 0 0 20px rgba(0, 242, 255, 0.5); transform: translateY(-2px); }
        
        #loadingScreen {
            position: fixed;
            inset: 0;
            background: #020617;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.8s ease-out;
        }
        .neon-title-loading {
            font-size: clamp(2rem, 8vw, 4rem);
            font-weight: 900;
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue), 0 0 30px var(--neon-blue);
            text-align: center;
            letter-spacing: 0.1em;
        }
        .loading-container {
            width: 250px;
            margin-top: 2rem;
            text-align: center;
        }

        #gameShop { 
            width: 100%; 
            height: 90px; 
            border-bottom: 1px solid rgba(0, 242, 255, 0.2); 
            overflow-x: auto;
            overflow-y: hidden;
            display: none; 
            align-items: center;
            padding: 0 10px;
            z-index: 50;
            background: rgba(2, 6, 23, 0.95);
            flex-shrink: 0;
        }

        .shop-container { 
            display: flex; 
            flex-direction: row; 
            gap: 10px; 
            min-width: max-content; 
            padding: 5px;
        }

        .unit-card {
            background: rgba(30, 41, 59, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            width: 70px;
            height: 75px; 
            flex-shrink: 0;
        }
        
        .unit-card.active { border-color: var(--neon-blue); background: rgba(0, 242, 255, 0.1); box-shadow: 0 0 15px rgba(0, 242, 255, 0.4); }
        
        .map-btn, .diff-btn { transition: 0.3s; border: 1px solid rgba(255,255,255,0.1); }
        .map-btn.selected, .diff-btn.selected { border-color: #00f2ff; background: rgba(0, 242, 255, 0.1); box-shadow: 0 0 15px rgba(0, 242, 255, 0.3); }
        
        #customAlert { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; pointer-events: none; }
        .vip-rank { color: #fde047; text-shadow: 0 0 10px #fde047; font-weight: bold; }

        #unitShopModal, #normalShopModal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; }
        
        .game-viewport {
            flex-grow: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background: #020617;
        }

        #gameHud {
            flex-shrink: 0;
        }
    </style>
</head>
<body class="main-container">

    <div id="loadingScreen">
        <h1 class="neon-title-loading">NEON DEFENSE</h1>
        <div class="loading-container">
            <div class="w-full h-1 bg-slate-800 rounded-full overflow-hidden">
                <div id="loadingBar" class="h-full bg-cyan-400 shadow-[0_0_15px_#22d3ee]" style="width: 0%"></div>
            </div>
            <p class="mt-4 text-[10px] text-cyan-400 tracking-[0.5em] animate-pulse uppercase">Initializing System...</p>
        </div>
    </div>

    <div id="customAlert"></div>

    <div id="mainMenu" class="fixed inset-0 z-50 flex items-center justify-center bg-[#020617]">
        <div class="glass-panel p-8 rounded-3xl w-full max-w-2xl text-center border-cyan-500/30 overflow-y-auto max-h-screen m-4">
            <h2 class="text-3xl font-black mb-2 text-cyan-400 drop-shadow-[0_0_10px_rgba(34,211,238,0.5)]">NEON DEFENSE <span class="text-sm opacity-50">v.1.1</span></h2>
            
            <div class="flex justify-center gap-4 mb-6">
                <div class="bg-slate-900 p-4 rounded-2xl border border-white/5 flex-1">
                    <div class="text-[10px] text-slate-500 uppercase">NeonCoin</div>
                    <div class="text-xl font-bold text-yellow-400" id="globalCoins">0</div>
                </div>
                <div class="bg-slate-900 p-4 rounded-2xl border border-white/5 flex-1">
                    <div class="text-[10px] text-slate-500">RANK</div>
                    <div class="text-sm font-bold" id="vipLabel">RECRUIT</div>
                </div>
            </div>

            <div class="mb-4 p-4 bg-slate-900/50 rounded-2xl border border-cyan-500/20 text-left">
                <div class="flex justify-between items-center mb-1">
                    <span class="text-[10px] font-bold text-cyan-400 uppercase">Daily Quest: Sector Explorer</span>
                    <span class="text-[10px] text-slate-400" id="questResetTime">Reset in: --:--</span>
                </div>
                <p class="text-[9px] text-slate-300 mb-2">Play 3 Easy matches to receive 500 NeonCoins.</p>
                <div class="w-full h-1.5 bg-slate-800 rounded-full overflow-hidden">
                    <div id="questBar" class="h-full bg-green-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between mt-1">
                    <span class="text-[10px] text-slate-500" id="questProgress">0 / 3</span>
                    <span class="text-[10px] font-bold text-yellow-500" id="questStatus">ACTIVE</span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="text-left space-y-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest">Select Arena</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="window.selectMap(0)" id="map0" class="map-btn p-3 rounded-xl bg-slate-800 text-[10px] selected">SECTOR A</button>
                        <button onclick="window.selectMap(1)" id="map1" class="map-btn p-3 rounded-xl bg-slate-800 text-[10px]">CORRIDOR B</button>
                    </div>
                    
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest pt-2">Difficulty</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="window.selectDiff('easy')" id="diffEasy" class="diff-btn p-3 rounded-xl bg-slate-800 text-[10px] selected text-green-400">EASY (20 Waves)</button>
                        <button onclick="window.selectDiff('hard')" id="diffHard" class="diff-btn p-3 rounded-xl bg-slate-800 text-[10px] text-red-500">HARD (35 Waves)</button>
                    </div>
                </div>
                <div class="text-left space-y-4">
                    <button onclick="window.toggleUnitShop(true)" class="w-full py-3 bg-purple-600/30 border border-purple-500/50 rounded-2xl font-bold text-xs hover:bg-purple-600/50 transition">UNIT PERMANENT SHOP</button>
                    <button onclick="window.toggleNormalShop(true)" class="w-full py-3 bg-white/10 border border-white/20 rounded-2xl font-bold text-xs hover:bg-white/20 transition">NORMAL SHOP (Match Use)</button>
                    <div class="bg-slate-900/50 p-4 rounded-xl border border-white/5">
                        <input type="text" id="cheatCode" placeholder="ENTER CODE..." class="w-full bg-black/40 border border-white/10 p-2 rounded text-[10px] mb-2 text-cyan-400 outline-none">
                        <button onclick="window.applyCheat()" class="w-full bg-white/5 py-1 text-[8px] rounded hover:bg-white/10">SUBMIT CODE</button>
                    </div>
                </div>
            </div>

            <div class="space-y-3">
                <button onclick="window.startGame()" class="neon-btn w-full py-4 bg-cyan-600 rounded-2xl font-bold text-white shadow-lg shadow-cyan-900/40">INITIALIZE MISSION</button>
                <button id="buyVipBtn" onclick="window.buyVip()" class="w-full py-3 bg-gradient-to-r from-amber-600 to-yellow-500 rounded-2xl font-bold text-xs text-white">PURCHASE VIP (3000 NeonCoins)</button>
            </div>
        </div>
    </div>

    <div id="unitShopModal" class="p-4">
        <div class="glass-panel p-6 rounded-3xl w-full max-w-xl">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-purple-400 uppercase">Permanent Unit Shop</h2>
                <button onclick="window.toggleUnitShop(false)" class="text-slate-500">CLOSE</button>
            </div>
            <div class="grid grid-cols-1 gap-4 overflow-y-auto max-h-[60vh]" id="unitShopList"></div>
            <div class="mt-6 text-center text-[10px] text-slate-500">NeonCoins: <span class="text-yellow-500 font-bold" id="shopCoins">0</span></div>
        </div>
    </div>

    <div id="normalShopModal" class="p-4">
        <div class="glass-panel p-6 rounded-3xl w-full max-w-xl border-white/20">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black text-white uppercase">Normal Shop (Match Use)</h2>
                <button onclick="window.toggleNormalShop(false)" class="text-slate-500">CLOSE</button>
            </div>
            <div class="grid grid-cols-1 gap-4 overflow-y-auto max-h-[60vh]" id="normalShopList"></div>
            <div class="mt-6 text-center text-[10px] text-slate-500">NeonCoins: <span class="text-yellow-500 font-bold" id="normalShopCoins">0</span></div>
        </div>
    </div>

    <div id="gameHud" class="glass-panel p-4 flex justify-between items-center z-30 border-b border-cyan-500/20 hidden">
        <div class="flex gap-4">
            <div class="flex flex-col">
                <span class="text-[10px] text-cyan-400 font-bold uppercase">Cash</span>
                <span class="text-xl font-black text-yellow-400 tabular-nums">$<span id="money">2000</span></span>
            </div>
            <div class="flex flex-col min-w-[120px]">
                <div class="flex justify-between items-center">
                    <span class="text-[10px] text-red-500 font-bold uppercase">Base Core</span>
                    <button id="repairBtn" onclick="window.repairCore()" class="hidden bg-green-600 text-[8px] px-2 py-0.5 rounded font-bold">REPAIR (<span id="repairCount">2</span>)</button>
                </div>
                <div class="w-full h-2 bg-slate-800 rounded-full mt-1 overflow-hidden">
                    <div id="healthBar" class="h-full bg-red-500 shadow-[0_0_10px_#ef4444]" style="width: 100%"></div>
                </div>
            </div>
        </div>
        <div class="text-center">
            <span class="text-[10px] text-slate-500 uppercase">Wave</span>
            <div class="text-xl font-black text-white" id="wave">1</div>
        </div>
        <button id="nextWaveBtn" class="neon-btn bg-cyan-600 hover:bg-cyan-500 px-6 py-2 rounded-xl font-bold text-xs uppercase">Next Swarm</button>
    </div>

    <div id="gameShop" class="glass-panel">
        <div class="shop-container" id="shop"></div>
    </div>

    <div class="game-viewport">
        <canvas id="gameCanvas"></canvas>
        
        <div id="upgradeMenu" class="absolute hidden glass-panel p-5 rounded-2xl z-40 w-64 border-cyan-500/40 shadow-xl shadow-cyan-500/10">
            <h3 id="unitName" class="font-black text-cyan-400 text-lg italic uppercase">UNIT</h3>
            <p id="unitStats" class="text-[11px] text-slate-400 mb-2 uppercase">Stats...</p>
            <p id="upgradeLevel" class="text-[10px] text-yellow-500 font-bold mb-4">Upgrades: 0/3</p>
            <div class="space-y-2">
                <button id="upgradeBtn" class="neon-btn w-full py-3 bg-emerald-600 hover:bg-emerald-500 rounded-xl font-bold text-xs text-white">UPGRADE</button>
                <button id="sellBtn" class="neon-btn w-full py-3 bg-red-900/40 border border-red-500/40 hover:bg-red-600 rounded-xl font-bold text-xs text-white">SELL (<span id="sellValue">$0</span>)</button>
                <button onclick="window.closeUpgradeMenu()" class="w-full py-2 text-[10px] text-slate-500 uppercase pt-2">Close</button>
            </div>
        </div>

        <div id="gameResult" class="absolute hidden inset-0 z-50 flex items-center justify-center bg-black/90 backdrop-blur-md">
            <div class="text-center">
                <h2 id="resultTitle" class="text-5xl font-black mb-4 uppercase">SYSTEM BREACHED</h2>
                <div class="text-yellow-500 text-xl font-bold mb-6" id="resultReward"></div>
                <button onclick="location.reload()" class="neon-btn px-10 py-4 bg-white text-black font-bold rounded-full">REBOOT SYSTEM</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT SECTION (FIXED FOR INDEX.HTML COMPATIBILITY) -->
    <script>
        // Global variables for game logic
        let globalCoins = 0;
        let isVip = false;
        let ownedUnits = ['scout', 'sniper', 'boom', 'wall'];
        let usedCodes = [];
        let questData = { progress: 0, lastReset: Date.now(), completed: false };
        let temporaryUnits = [];
        
        const STORAGE_KEY = 'neon_defense_save_v1';

        // STORAGE LOGIC (LÆ°u trá»¯ bá»n vá»¯ng trÃªn localStorage)
        function saveProfile() {
            const data = {
                globalCoins,
                isVip,
                ownedUnits,
                usedCodes,
                questData
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            console.log("Profile Saved to LocalStorage");
        }

        function loadProfile() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    globalCoins = data.globalCoins || 0;
                    isVip = data.isVip || false;
                    ownedUnits = data.ownedUnits || ['scout', 'sniper', 'boom', 'wall'];
                    usedCodes = data.usedCodes || [];
                    questData = data.questData || { progress: 0, lastReset: Date.now(), completed: false };
                } catch(e) { console.error("Load failed", e); }
            }
        }

        // Initialize audio and canvas
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let audioCtx;
        try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) {}

        // State Variables for Gameplay
        let gameActive = false, selectedMapIdx = 0, selectedDiffVal = 'easy';
        let gameState = { money: 2000, wave: 1, towers: [], health: 100, maxHealth: 100, isWaveActive: false, difficulty: 'easy', vipTimer: 0, repairsLeft: 2 };
        let enemies = [], projectiles = [], particles = [];
        let selectedPlacement = null, selectedTowerId = null, mousePos = { x: 0, y: 0 };

        // Core UI helpers
        function playSound(freq, type = 'sine', duration = 0.1, vol = 0.1) {
            if (!audioCtx) return;
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(vol, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start();
                osc.stop(audioCtx.currentTime + duration);
            } catch(e) {}
        }
        const playClick = () => playSound(800, 'square', 0.05, 0.05);
        const playUpgrade = () => { playSound(400, 'sine', 0.1); playSound(600, 'sine', 0.2, 0.1); };

        function showAlert(msg, color="cyan") {
            const alertContainer = document.getElementById('customAlert');
            const el = document.createElement('div');
            el.className = `px-6 py-2 rounded-full font-bold text-xs bg-slate-800 text-white border border-${color === 'red' ? 'red' : 'cyan'}-500/50 mb-2 shadow-lg transition-opacity duration-300`;
            el.innerText = msg;
            alertContainer.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 300); }, 3000);
        }

        // Game Data
        const mapWays = [
            [{x:-50,y:400}, {x:250,y:400}, {x:250,y:150}, {x:600,y:150}, {x:600,y:600}, {x:950,y:600}, {x:950,y:350}, {x:1250,y:350}],
            [{x:150,y:-50}, {x:150,y:600}, {x:500,y:600}, {x:500,y:200}, {x:850,y:200}, {x:850,y:950}]
        ];

        const towerData = {
            scout: { type: 'scout', name: "GUN", price: 150, range: 160, dmg: 40, maxDmg: 250, spd: 60, maxSpd: 30, color: "#00f2ff", emoji: "ðŸ”«", p_spd: 12, upgradeInit: 150 },
            sniper: { type: 'sniper', name: "SNIPER", price: 500, range: 450, dmg: 100, maxDmg: 400, spd: 240, maxSpd: 30, color: "#bc13fe", emoji: "ðŸŽ¯", p_spd: 22, upgradeInit: 300 },
            boom: { type: 'boom', name: "ROCKET", price: 850, range: 220, dmg: 200, maxDmg: 700, spd: 200, maxSpd: 60, color: "#ff003c", emoji: "ðŸš€", p_spd: 8, upgradeInit: 500, upgradeMax: 1500 },
            ak47: { type: 'ak47', name: "MINI GUN", price: 1300, range: 250, dmg: 120, maxDmg: 800, spd: 60, maxSpd: 0, color: "#fde047", emoji: "ðŸ”«", p_spd: 15, upgradeInit: 1000, upgradeMax: 3000 },
            wall: { type: 'wall', name: "WALL", price: 1500, range: 60, dmg: 30, maxDmg: 30, spd: 0, color: "#10b981", emoji: "ðŸš§", p_spd: 0, upgradeInit: 800, hp: 500, maxHp: 1200 },
            lazer: { type: 'lazer', name: "LAZER", price: 2000, range: 300, dmg: 10, maxDmg: 1000, spd: 1, color: "#ff0000", emoji: "âš¡", p_spd: 0, upgradeInit: 1000, isLaser: true },
            freeze: { type: 'freeze', name: "FREEZE", price: 2200, range: 250, dmg: 20, maxDmg: 500, spd: 60, maxSpd: 60, color: "#00ffff", emoji: "â„ï¸", p_spd: 10, upgradeInit: 1200, isFreeze: true },
            boom_pro: { type: 'boom_pro', name: "BOOM", price: 3000, range: 350, dmg: 400, maxDmg: 1200, spd: 120, maxSpd: 120, color: "#ff8800", emoji: "ðŸ’¥", p_spd: 10, upgradeInit: 1500, isArea: true }
        };

        const shopItems = [
            { id: 'ak47', name: 'MINI GUN', emoji: 'ðŸ”«', cost: 3500, desc: 'High fire rate.' },
            { id: 'lazer', name: 'LAZER', emoji: 'âš¡', cost: 3000, desc: 'Continuous red beam.' },
            { id: 'freeze', name: 'FREEZE', emoji: 'â„ï¸', cost: 3200, desc: 'Slows targets.' },
            { id: 'boom_pro', name: 'BOOM', emoji: 'ðŸ’¥', cost: 2500, desc: 'Explosive AOE.' }
        ];

        const normalShopItems = [
            { id: 'ak47', name: 'MINI GUN (Match)', emoji: 'ðŸ”«', cost: 450, desc: 'Single match use.' },
            { id: 'lazer', name: 'LAZER (Match)', emoji: 'âš¡', cost: 300, desc: 'Single match use.' },
            { id: 'freeze', name: 'FREEZE (Match)', emoji: 'â„ï¸', cost: 250, desc: 'Single match use.' },
            { id: 'boom_pro', name: 'BOOM (Match)', emoji: 'ðŸ’¥', cost: 300, desc: 'Single match use.' }
        ];

        // Global functions (Attached to window for HTML onclicks)
        window.selectMap = (i) => { playClick(); selectedMapIdx = i; document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('selected')); document.getElementById('map'+i).classList.add('selected'); };
        window.selectDiff = (d) => { playClick(); selectedDiffVal = d; document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('selected')); document.getElementById('diff' + d.charAt(0).toUpperCase() + d.slice(1)).classList.add('selected'); };
        
        window.toggleUnitShop = (show) => {
            playClick();
            document.getElementById('unitShopModal').style.display = show ? 'flex' : 'none';
            if (show) renderUnitShop();
        };

        window.toggleNormalShop = (show) => {
            playClick();
            document.getElementById('normalShopModal').style.display = show ? 'flex' : 'none';
            if (show) renderNormalShop();
        };

        window.buyUnit = (id, cost) => {
            playClick();
            if (globalCoins >= cost && !ownedUnits.includes(id)) {
                globalCoins -= cost;
                ownedUnits.push(id);
                saveProfile();
                updateMenuUI();
                renderUnitShop();
                showAlert("UNIT PURCHASED", "emerald");
            } else showAlert(ownedUnits.includes(id) ? "OWNED" : "NO COINS", "red");
        };

        window.buyNormalUnit = (id, cost) => {
            playClick();
            if (globalCoins >= cost && !temporaryUnits.includes(id) && !ownedUnits.includes(id)) {
                globalCoins -= cost;
                temporaryUnits.push(id);
                saveProfile();
                updateMenuUI();
                renderNormalShop();
                showAlert("READY FOR MATCH", "cyan");
            } else showAlert("ALREADY READY", "red");
        };

        window.applyCheat = () => {
            const code = document.getElementById('cheatCode').value.trim().toLowerCase();
            if (code === 'get3k' && !usedCodes.includes('get3k')) {
                globalCoins += 3000; usedCodes.push('get3k'); saveProfile(); updateMenuUI(); showAlert("+3000 COINS", "emerald");
            } else if (code === 'neondefendev1' && !usedCodes.includes('neondefendev1')) {
                globalCoins += 500; usedCodes.push('neondefendev1'); saveProfile(); updateMenuUI(); showAlert("+500 COINS", "emerald");
            } else showAlert("INVALID OR USED", "red");
            document.getElementById('cheatCode').value = "";
        };

        window.buyVip = () => {
            if (globalCoins >= 3000 && !isVip) {
                globalCoins -= 3000; isVip = true; saveProfile(); updateMenuUI(); showAlert("VIP ACTIVE", "emerald");
            } else showAlert("NO COINS", "red");
        };

        // UI Rendering Logic
        function updateMenuUI() {
            document.getElementById('globalCoins').innerText = globalCoins;
            const vipLabel = document.getElementById('vipLabel');
            if (isVip) {
                vipLabel.innerText = "ðŸ‘‘ VIP"; vipLabel.classList.add('vip-rank');
                document.getElementById('buyVipBtn').style.display = 'none';
            }
            updateQuestUI();
        }

        function updateQuestUI() {
            const bar = document.getElementById('questBar');
            const progTxt = document.getElementById('questProgress');
            if(bar) bar.style.width = (questData.progress / 3 * 100) + '%';
            if(progTxt) progTxt.innerText = `${questData.progress} / 3`;
        }

        function renderUnitShop() {
            const list = document.getElementById('unitShopList');
            document.getElementById('shopCoins').innerText = globalCoins;
            list.innerHTML = "";
            shopItems.forEach(item => {
                const owned = ownedUnits.includes(item.id);
                list.innerHTML += `<div class="bg-slate-900 p-4 rounded-2xl flex justify-between items-center border border-white/5">
                    <div><div class="font-bold text-purple-400">${item.name} ${item.emoji}</div><div class="text-[9px] text-slate-500">${item.desc}</div></div>
                    <button onclick="buyUnit('${item.id}', ${item.cost})" class="px-4 py-2 rounded-xl text-[10px] ${owned ? 'bg-slate-800' : 'bg-purple-600'}">${owned ? 'OWNED' : item.cost}</button>
                </div>`;
            });
        }

        function renderNormalShop() {
            const list = document.getElementById('normalShopList');
            document.getElementById('normalShopCoins').innerText = globalCoins;
            list.innerHTML = "";
            normalShopItems.forEach(item => {
                const ready = ownedUnits.includes(item.id) || temporaryUnits.includes(item.id);
                list.innerHTML += `<div class="bg-slate-900 p-4 rounded-2xl flex justify-between items-center border border-white/5">
                    <div><div class="font-bold text-white">${item.name} ${item.emoji}</div><div class="text-[9px] text-slate-400">${item.desc}</div></div>
                    <button onclick="buyNormalUnit('${item.id}', ${item.cost})" class="px-4 py-2 rounded-xl text-[10px] ${ready ? 'bg-slate-800' : 'bg-white text-black'}">${ready ? 'READY' : item.cost}</button>
                </div>`;
            });
        }

        function renderInGameShop() {
            const shop = document.getElementById('shop');
            shop.innerHTML = "";
            const available = [...new Set([...ownedUnits, ...temporaryUnits])];
            available.forEach(key => {
                const t = towerData[key];
                const price = Math.floor(isVip ? t.price * 0.8 : t.price);
                const div = document.createElement('div');
                div.className = 'unit-card';
                div.innerHTML = `<div class="text-xl">${t.emoji}</div><span class="text-[8px] font-bold text-cyan-400">${t.name}</span><span class="text-[10px] text-yellow-500">$${price}</span>`;
                div.onclick = () => {
                    selectedPlacement = key;
                    document.querySelectorAll('.unit-card').forEach(c => c.classList.remove('active'));
                    div.classList.add('active');
                };
                shop.appendChild(div);
            });
        }

        // Gameplay Logic
        window.startGame = () => {
            playClick();
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('gameHud').classList.remove('hidden');
            document.getElementById('gameShop').style.display = 'flex';
            
            gameState = { money: 2000, wave: 1, towers: [], health: 100, maxHealth: 100, isWaveActive: false, difficulty: selectedDiffVal, vipTimer: 0, repairsLeft: 2 };
            enemies = []; projectiles = [];
            gameActive = true;
            
            if (isVip) document.getElementById('repairBtn').classList.remove('hidden');
            renderInGameShop();
            updateUI();
            resize();
            requestAnimationFrame(gameLoop);
        };

        function updateUI() {
            document.getElementById('money').innerText = Math.floor(gameState.money);
            document.getElementById('wave').innerText = gameState.wave;
            document.getElementById('healthBar').style.width = gameState.health + '%';
        }

        // (Keeping original Tower/Enemy logic from your file...)
        function isNearPath(x, y, dist) {
            const wps = mapWays[selectedMapIdx];
            for (let i=0; i < wps.length-1; i++) {
                const p1 = wps[i], p2 = wps[i+1];
                const L2 = Math.pow(p2.x-p1.x, 2) + Math.pow(p2.y-p1.y, 2); if (L2 === 0) continue;
                let t = ((x-p1.x)*(p2.x-p1.x) + (y-p1.y)*(p2.y-p1.y)) / L2;
                t = Math.max(0, Math.min(1, t));
                const dx = x - (p1.x + t*(p2.x-p1.x)), dy = y - (p1.y + t*(p2.y-p1.y));
                if (Math.sqrt(dx*dx + dy*dy) < dist) return true;
            }
            return false;
        }

        canvas.addEventListener('pointerdown', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);

            if (selectedPlacement) {
                const t = towerData[selectedPlacement];
                const price = Math.floor(isVip ? t.price * 0.8 : t.price);
                if (gameState.money >= price) {
                    const isWall = t.type === 'wall';
                    const onPath = isNearPath(x, y, 40);
                    if ((isWall && onPath) || (!isWall && !onPath)) {
                        gameState.towers.push({...t, x, y, id: Date.now(), level: 0, timer: 0, upgradeCost: t.upgradeInit, totalInvested: price, currentDmg: t.dmg, currentSpd: t.spd, currentHp: t.hp || 0, currentMaxHp: t.hp || 0});
                        gameState.money -= price; updateUI(); selectedPlacement = null;
                        document.querySelectorAll('.unit-card').forEach(c => c.classList.remove('active'));
                    }
                }
                return;
            }
            const clicked = gameState.towers.find(t => Math.hypot(t.x-x, t.y-y) < 40);
            if (clicked) openUpgrade(clicked, e.clientX, e.clientY);
            else window.closeUpgradeMenu();
        });

        function openUpgrade(tower, sx, sy) {
            const menu = document.getElementById('upgradeMenu');
            document.getElementById('unitName').innerText = tower.name;
            document.getElementById('upgradeLevel').innerText = `Level ${tower.level}/3`;
            const sellValue = Math.floor(tower.totalInvested * 0.6);
            document.getElementById('sellValue').innerText = `$${sellValue}`;
            
            document.getElementById('upgradeBtn').onclick = () => {
                if (gameState.money >= tower.upgradeCost && tower.level < 3) {
                    gameState.money -= tower.upgradeCost;
                    tower.level++;
                    tower.totalInvested += tower.upgradeCost;
                    tower.upgradeCost = Math.floor(tower.upgradeCost * 1.5);
                    tower.currentDmg *= 1.3; tower.range += 20;
                    updateUI(); openUpgrade(tower, sx, sy);
                }
            };
            document.getElementById('sellBtn').onclick = () => {
                gameState.money += sellValue;
                gameState.towers = gameState.towers.filter(t => t.id !== tower.id);
                updateUI(); window.closeUpgradeMenu();
            };

            menu.style.left = sx + 'px'; menu.style.top = (sy - 100) + 'px';
            menu.classList.remove('hidden');
        }
        window.closeUpgradeMenu = () => document.getElementById('upgradeMenu').classList.add('hidden');

        document.getElementById('nextWaveBtn').onclick = () => {
            if (gameState.isWaveActive) return;
            gameState.isWaveActive = true;
            let count = 0; let total = 10 + gameState.wave * 2;
            const wps = mapWays[selectedMapIdx];
            const spawn = setInterval(() => {
                if (!gameActive) { clearInterval(spawn); return; }
                const hp = 100 + (gameState.wave * 50);
                enemies.push({x: wps[0].x, y: wps[0].y, hp, maxHp: hp, baseSpd: 1.2 + (gameState.wave * 0.05), wp: 0, slowFactor: 1});
                if (++count >= total) { clearInterval(spawn); }
            }, 600);
        };

        function gameLoop() {
            if (!gameActive) return;
            ctx.fillStyle = '#020617'; ctx.fillRect(0,0,canvas.width,canvas.height);
            const wps = mapWays[selectedMapIdx];
            ctx.strokeStyle = '#0f172a'; ctx.lineWidth = 60; ctx.beginPath(); ctx.moveTo(wps[0].x, wps[0].y); wps.forEach(p => ctx.lineTo(p.x, p.y)); ctx.stroke();

            // Towers
            gameState.towers.forEach(t => {
                ctx.fillStyle = t.color; ctx.beginPath(); ctx.arc(t.x, t.y, 25, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = 'white'; ctx.fillText(t.emoji, t.x-10, t.y+5);
                
                if (!t.isLaser && ++t.timer >= t.currentSpd) {
                    const target = enemies.find(e => Math.hypot(e.x-t.x, e.y-t.y) < t.range);
                    if (target) {
                        projectiles.push({x: t.x, y: t.y, target, spd: 10, dmg: t.currentDmg, color: t.color});
                        t.timer = 0;
                    }
                }
            });

            // Enemies
            for(let i=enemies.length-1; i>=0; i--) {
                const e = enemies[i];
                const tar = wps[e.wp+1];
                const d = Math.hypot(tar.x-e.x, tar.y-e.y);
                e.x += (tar.x-e.x)/d * e.baseSpd; e.y += (tar.y-e.y)/d * e.baseSpd;
                if (d < 5 && ++e.wp >= wps.length-1) { gameState.health -= 10; enemies.splice(i,1); updateUI(); continue; }
                
                ctx.fillStyle = '#ff003c'; ctx.beginPath(); ctx.arc(e.x, e.y, 15, 0, Math.PI*2); ctx.fill();
                if (e.hp <= 0) { enemies.splice(i,1); globalCoins += 5; gameState.money += 50; updateUI(); saveProfile(); continue; }
            }

            // Projectiles
            for(let i=projectiles.length-1; i>=0; i--) {
                const p = projectiles[i];
                const d = Math.hypot(p.target.x-p.x, p.target.y-p.y);
                p.x += (p.target.x-p.x)/d * p.spd; p.y += (p.target.y-p.y)/d * p.spd;
                ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill();
                if (d < 10) { p.target.hp -= p.dmg; projectiles.splice(i,1); }
            }

            if (gameState.health <= 0) endGame(false);
            if (gameState.isWaveActive && enemies.length === 0) { gameState.isWaveActive = false; gameState.wave++; updateUI(); }

            requestAnimationFrame(gameLoop);
        }

        function endGame(won) {
            gameActive = false;
            document.getElementById('gameResult').classList.remove('hidden');
            document.getElementById('resultTitle').innerText = won ? "VICTORY" : "DEFEAT";
            if (won) { globalCoins += 500; saveProfile(); }
        }

        function resize() {
            canvas.width = 1200; canvas.height = 800;
        }

        // INITIALIZATION
        window.onload = () => {
            loadProfile();
            updateMenuUI();
            
            // Loading screen logic
            const bar = document.getElementById('loadingBar');
            let p = 0;
            const intv = setInterval(() => {
                p += 5; bar.style.width = p + '%';
                if (p >= 100) {
                    clearInterval(intv);
                    setTimeout(() => document.getElementById('loadingScreen').style.display = 'none', 500);
                }
            }, 50);
        };
    </script>
</body>
</html>

