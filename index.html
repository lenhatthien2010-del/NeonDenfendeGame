<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sustainable User Data Storage - Lưu trữ dữ liệu bền vững</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f3f4f6; font-family: sans-serif; }
        .game-container { max-width: 500px; margin: 50px auto; padding: 20px; background: white; border-radius: 12px; shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="game-container text-center">
    <h1 class="text-2xl font-bold mb-4">Clicker Game (Firestore Storage)</h1>
    
    <!-- User Profile Section / Phần hồ sơ người dùng -->
    <div id="auth-section" class="mb-6 p-4 border rounded">
        <p id="user-status" class="text-gray-600 mb-2">Connecting... (Đang kết nối...)</p>
        <div id="user-info" class="hidden">
            <p class="font-semibold">User ID: <span id="display-uid" class="text-blue-600"></span></p>
        </div>
    </div>

    <!-- Game Logic Section / Phần logic trò chơi -->
    <div class="mb-6">
        <h2 class="text-4xl font-black text-indigo-600 mb-2" id="score-display">0</h2>
        <p class="text-sm text-gray-500 mb-4 italic">Scores are saved automatically (Điểm số được lưu tự động)</p>
        <button id="click-btn" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full transition-all active:scale-95">
            CLICK ME! (BẤM VÀO TÔI!)
        </button>
    </div>

    <!-- Leaderboard / Bảng xếp hạng -->
    <div class="mt-8">
        <h3 class="font-bold text-lg border-b pb-2 mb-2">Global Leaderboard (Bảng xếp hạng)</h3>
        <ul id="leaderboard" class="text-left space-y-1">
            <!-- Data will be injected here / Dữ liệu sẽ được chèn vào đây -->
        </ul>
    </div>
</div>

<!-- Firebase SDKs -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 1. Configuration (Cấu hình Firebase)
    const firebaseConfig = JSON.parse(__firebase_config);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // 2. Initialize Services (Khởi tạo dịch vụ)
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentScore = 0;

    // UI Elements (Các thành phần giao diện)
    const scoreDisplay = document.getElementById('score-display');
    const clickBtn = document.getElementById('click-btn');
    const userStatus = document.getElementById('user-status');
    const displayUid = document.getElementById('display-uid');
    const userInfoDiv = document.getElementById('user-info');
    const leaderboardList = document.getElementById('leaderboard');

    // 3. Authentication Logic (Logic xác thực - RULE 3)
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Auth Error (Lỗi xác thực):", error);
            userStatus.innerText = "Connection failed (Kết nối thất bại)";
        }
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            userStatus.innerText = "Status: Online (Trạng thái: Trực tuyến)";
            displayUid.innerText = user.uid;
            userInfoDiv.classList.remove('hidden');
            loadUserData(user.uid);
            setupLeaderboard();
        }
    });

    // 4. Load Data (Tải dữ liệu người dùng - RULE 1)
    async function loadUserData(userId) {
        if (!userId) return;
        // Path: /artifacts/{appId}/users/{userId}/gameData/profile
        const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'gameData', 'profile');
        const docSnap = await getDoc(userDocRef);

        if (docSnap.exists()) {
            currentScore = docSnap.data().score || 0;
            scoreDisplay.innerText = currentScore;
        } else {
            // New user, create record (Người dùng mới, tạo bản ghi)
            await saveUserData(0);
        }
    }

    // 5. Save Data (Lưu dữ liệu bền vững)
    async function saveUserData(newScore) {
        if (!currentUser) return;
        const userId = currentUser.uid;
        
        try {
            // Private data path (Đường dẫn dữ liệu riêng tư)
            const userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'gameData', 'profile');
            await setDoc(userDocRef, { score: newScore }, { merge: true });

            // Public data path for leaderboard (Đường dẫn dữ liệu công khai cho bảng xếp hạng)
            const publicDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', userId);
            await setDoc(publicDocRef, { 
                uid: userId, 
                score: newScore,
                updatedAt: Date.now()
            }, { merge: true });

        } catch (error) {
            console.error("Save Error (Lỗi lưu dữ liệu):", error);
        }
    }

    // 6. Leaderboard Listener (Theo dõi bảng xếp hạng - RULE 2)
    function setupLeaderboard() {
        if (!currentUser) return;
        const leaderboardCol = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
        
        // Listen for real-time updates (Lắng nghe cập nhật thời gian thực)
        onSnapshot(leaderboardCol, (snapshot) => {
            const players = [];
            snapshot.forEach(doc => players.push(doc.data()));
            
            // Sort in memory (Sắp xếp trong bộ nhớ - RULE 2)
            players.sort((a, b) => b.score - a.score);

            leaderboardList.innerHTML = '';
            players.slice(0, 5).forEach((player, index) => {
                const li = document.createElement('li');
                li.className = "flex justify-between p-2 border-b text-sm";
                li.innerHTML = `
                    <span>${index + 1}. <small>${player.uid}</small></span>
                    <span class="font-bold">${player.score}</span>
                `;
                leaderboardList.appendChild(li);
            });
        }, (error) => {
            console.error("Leaderboard Error:", error);
        });
    }

    // Event Listeners
    clickBtn.addEventListener('click', () => {
        if (!currentUser) return;
        currentScore++;
        scoreDisplay.innerText = currentScore;
        saveUserData(currentScore);
    });

    // Start Auth
    initAuth();

</script>

</body>
</html>

